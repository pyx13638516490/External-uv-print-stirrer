# ESP32 多功能步进电机控制器

这是一个基于 ESP32 和 MicroPython 的高精度、多功能步进电机控制器项目。它集成了一个OLED显示屏、旋转编码器、多个触发器和一个继电器，通过硬件PWM和梯形加减速算法，实现了步进电机平滑、高速的往复运动控制。

---

## 🚀 功能特性

- **OLED 显示界面**: 1.3寸OLED屏幕实时显示距离、速度、延时等参数以及系统状态。
- **旋转编码器控制**: 使用EC11旋转编码器，可以方便、精确地调整各项参数，并通过按压切换设置项。
- **硬件PWM驱动**: 利用ESP32的硬件PWM模块生成脉冲，实现高达100mm/s的精确、稳定和高速的电机运动。
- **梯形加减速算法**: 内置梯形加减速控制，使电机启动和停止过程极其平滑，有效防止抖动和丢步。
- **双重触发模式**:
    - **按键触发**: 一键启动/停止连续往复运动。
    - **光感顺序触发**: 通过“暗→亮→暗”的光线变化顺序，同步触发继电器和延时启动的电机运动。
- **继电器同步控制**: 在光感触发模式下，可与电机运动同步控制一个5V继电器。
- **紧急停止功能**: 独立的急停按钮，可在任何时候立即中断电机运动，确保安全。
- **参数断电保存**: 所有设置的参数（距离、速度、延时）都会自动保存在ESP32的闪存中，断电不丢失。
- **高度可配置**: 代码内的物理参数（电机步距角、微步、丝杆导程）和性能参数（加减速时间）均可轻松修改以适配不同硬件。

---

## 📦 硬件清单

| 元件 | 数量 | 备注 |
| :--- | :--- | :--- |
| ESP32 开发板 | 1 | 例如 ESP32-DevKitC, NodeMCU-32S |
| A4988 步进电机驱动器 | 1 | |
| 42步进电机 (或类似) | 1 | 4线双极步进电机 |
| 直线滑动模组 | 1 | 本项目配置为**12mm导程**的丝杆 |
| 1.3寸 SH1106 OLED (I2C) | 1 | 128x64 分辨率 |
| EC11 旋转编码器 (带按键) | 1 | |
| 5V 继电器模块 | 1 | |
| 光敏电阻模块 (4线) | 1 | 使用模拟输出(AO) |
| 普通按键 | 2 | 用于启动/停止 和 急停 |
| 10kΩ 电阻 | 1 | **(必需)** 用于按键硬件上拉，防止干扰 |
| 0.1µF (104) 陶瓷电容 | 1 | **(推荐)** 用于按键硬件滤波 |
| 外部电源 | 1 | **8V-35V**, 例如 12V 2A，用于电机供电 |
| 面包板, 杜邦线 | 若干 | |

---

## 🔌 硬件接线

**⚠️ 警告：所有接线操作必须在完全断电的情况下进行！**

### A. 电源连接 (最重要！)

| 电源/模块 | 引脚 | 连接到 |
| :--- | :--- | :--- |
| **ESP32** | `VIN` & `GND` | USB 或 5V 电源 |
| **A4988 逻辑电源**| `VDD` & `GND` | ESP32 的 `3V3` 和 `GND` |
| **A4988 电机电源**| `VMOT` & `GND` | **外部12V电源** 的 `+` 和 `-` |
| **5V 继电器** | `VCC` & `GND` | ESP32 的 `5V` 和 `GND` |
| **共地连接** | - | **必须将 ESP32的GND 与 外部12V电源的GND 连接在一起！** |

### B. 信号连接

| 元件 | ESP32 引脚 |
| :--- | :--- |
| OLED SCL | `GPIO 22` |
| OLED SDA | `GPIO 21` |
| A4988 `STEP` | `GPIO 17` |
| A4988 `DIR` | `GPIO 16` |
| A4988 `MS1`, `MS2` | `3V3` (设置为1/8步) |
| A4988 `MS3`, `ENABLE` | `GND` |
| 编码器 CLK (A) | `GPIO 18` |
| 编码器 DT (B) | `GPIO 19` |
| 编码器 SW | `GPIO 5` |
| **启动/停止按键** | `GPIO 13` | (另一端接GND, **强烈建议并联10kΩ电阻到3.3V**) |
| **紧急停止按键** | `GPIO 4` | (另一端接GND) |
| 光敏电阻 AO | `GPIO 34` |
| 5V继电器 IN | `GPIO 25` |

---

## 🔧 软件设置

1.  **烧录固件**: 确保您的ESP32已烧录最新的 [MicroPython 固件](https://micropython.org/download/esp32/)。
2.  **安装IDE**: 下载并安装 [Thonny IDE](https://thonny.org/)，它对MicroPython的支持非常好。
3.  **上传驱动文件**: 下载 [sh1106.py](https://github.com/micropython/micropython-oled/blob/master/sh1106.py) 驱动文件，并将其上传到ESP32的文件系统中。
4.  **上传主程序**: 将本项目的 `main.py` 文件上传到ESP32的文件系统中。
5.  **重启ESP32**: 按下ESP32上的`RST`或`EN`按钮，程序将自动运行。

---

## 🕹️ 如何使用

### 1. 参数调整
- **旋转编码器**: 调整屏幕上 `>` 指示符所在行的数值。
- **按压编码器**: 切换 `>` 指示符，在 `Dist` (距离), `Spd` (速度), `Delay` (延时) 之间循环。
- 所有参数修改后会自动保存。

### 2. 启动/停止电机
- **启动**: 按一下**启动/停止按键 (GPIO 13)**，电机将开始以设定的参数无限次往复运动。屏幕状态显示 `MOVING...`。
- **常规停止**: 在电机运动时，再按一下**启动/停止按键**，电机会在完成**当前**的往返周期后自动停止。屏幕状态显示 `MOVING(!)`。
- **紧急停止**: 在任何时候，按下**紧急停止按键 (GPIO 4)**，电机会**立即**停止所有运动。屏幕状态显示 `E-STOP!`。
    - **解除急停**: 在急停状态下，按一下**启动/停止按键 (GPIO 13)**可解除锁定，系统恢复到`IDLE`状态。

### 3. 光感触发
- **触发条件**: 完成一次“**暗 → 亮 → 暗**”的光线变化顺序。
- **触发动作**:
    1.  在检测到第二次“暗”的瞬间，**继电器立即通电**，并保持通电状态，时长为您在屏幕上设置的 `Delay` 值。
    2.  当 `Delay` 时间结束后，**继电器断电**，同时**步进电机立即开始**执行一次往返运动。

---

## ⚙️ 参数配置

您可以直接在 `main.py` 文件的顶部修改一些核心参数以适配您的硬件。

```python
# --- 物理参数配置 ---
STEPS_PER_REV = 200     # 电机每圈完整步数 (1.8°电机为200)
MICROSTEPPING = 8       # A4988的微步设置 (必须与硬件跳线一致)
LEAD_SCREW_PITCH = 12.0 # 丝杆导程 (mm/圈)

# --- 软件参数配置 ---
MAX_SPEED_MMS = 100.0   # 速度设置上限
MIN_SPEED_MMS = 1.0     # 最低启动速度
ACCEL_DURATION_S = 0.2  # 加减速花费的时间 (秒)
```